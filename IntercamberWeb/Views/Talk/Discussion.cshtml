@using CML.Intercamber.Business.Model
@{
    ViewBag.PageTitle = Resources.Intercamber.Chat_PageName;
}
@section PageHead {
    <style type="text/css">
        .container
        {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
    </style>
    <script src="/signalr/hubs"></script>
}


@section PageContent {
    <script type="text/javascript">
        $(function() {
            // load signalr chat
            var chat = $.connection.chatHub;
            chat.client.add = function(name, message, date) {
                printMessage(encodeText(name), encodeText(message), encodeText(date));
            };
            $('#message').focus();
            $.connection.hub.start().done(function() {
                chat.server.addToRoom("@(ViewBag.IdThread)");
                $('#sendmessage').click(function() {
                    chat.server.sendMessage("@(ViewBag.IdThread)", "@(ViewBag.MyName.Replace("\"", ""))", $('#message').val());
                    $('#message').val('').focus();
                });
            });
            // load chat history 
            $.ajax({
                type: "POST",
                url: "/Talk/ChatHistory",
                contentType: "application/json; charset=utf-8",
                data: "{'id':@(ViewBag.IdThread)}", 
                dataType: "json",
                success: function (result) {
                    for (var i = 0; i < result.length; i++) {
                        var r = result[i];
                        printMessage(r.Author, r.Message, r.Date);
                    }
                },
                error: function (result) {
                    debugger;
                }
            });
        });

        function encodeText(txt) {
            return $('<div />').text(txt).html();
        }

        function printMessage(name, message, date) {
            $('#discussion').append('<br/>[' + date + ']<strong>' + name + '</strong>:&nbsp;&nbsp;' + message + '');
        }
    </script>
    
    Chat with 
    @foreach (ThreadDetail td in ViewBag.currentThread)
    {
        @td.FirstName
        @td.LastName
        <br/>
    }
    <br/>
    
    <div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <div id="discussion">
        </div>
    </div>


}
